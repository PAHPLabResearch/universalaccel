---
title: "universalaccel (UA) Manual"
subtitle: "Part 1: Generating Metrics • Part 2: Analysis & Interpretation"

output:
  pdf_document:
    latex_engine: xelatex
    toc: false
    number_sections: false
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>",
  message  = FALSE,
  warning  = FALSE,
  echo     = FALSE   
)
```

# Contents

**Part 1 — Generating Metrics**

1. What UA is (universal accelerometry pipeline)  
2. Inputs and expectations (file formats, columns, epochs)  
3. Summarizing raw acceleration (`accel_summaries`)  
4. Output files and variable list (epoch-level metrics)  

**Part 2 — Analysis**

5. What “analysis-ready” means in UA (harmonized outputs)  
6. Daily summaries and bin distributions (intensity zones)  
7. NHANES references (Comparing observed volume and IG to normative values)  
8. Running Part 2 on a precomputed demo file (`ua_analyze_precomputed`)  
9. Output tables (Output1–Output5) and variable lists  

\newpage

# Abbreviations and Terms

- **UA** (*universalaccel*): the package ecosystem (functions + reference tables + output contracts).
- **ENMO** (*Euclidean Norm Minus One*): acceleration magnitude above 1g after removing the static component (autocalibration applied).
- **MAD** (*Mean Amplitude Deviation*): mean deviation of acceleration magnitude within an epoch.
- **AI** (*Activity Index*): variability-based activity metric computed from raw acceleration.
- **MIMS-unit** (*Monitor-Independent Movement Summary unit*): standardized activity summary intended to be comparable across devices.
- **ROCAM** (*Rate of Change Acceleration Movement*): change-based activity metric derived from successive acceleration movement samples.
- **AC** (*ActiGraph counts*): traditional “counts”.
- **NHANES** (*National Health and Nutrition Examination Survey*): U.S. survey used here as the reference population for zone boundaries and percentile tables.
- **Anchor** (*Default metric scale for conditioning*): the metric context used to define zones and percentiles; other metrics can be **equated** onto this anchor via **equipercentile** mapping.
- **Epoch** (*Aggregation window*): the time length used to summarize raw samples into rows (e.g., 5 seconds or 60 seconds).
- **AA** (*Average acceleration*/*Volume*): the daily time-weighted mean of the intensity distribution (computed from bin midpoints × minutes in bin).
- **IG** (*Intensity gradient*): the slope from regressing log(time in bin) on log(intensity midpoint); more negative means a steeper drop-off at higher intensities.


\newpage

# Part 1 — Generating Metrics (how to produce harmonized files)

## 1. What UA is (universalaccel)

**universalaccel (UA)** is an R pipeline for computing harmonized accelerometer summary metrics across multiple devices (Tested on: ActiGraph, Axivity, GENEActiv). The goal is to make raw accelerometer data comparable by producing standardized, epoch-level outputs with consistent naming, time handling, and reproducible settings.

### UA tested files and order of operations:

- ActiGraph (GT3X), .gt3x raw data is passed through `?agcounts::agcalibrate()` first and metrics are computed.
- Axivity (AX3), .resampled.CSV is autocalibrated in OmGui, so metrics are directly computed.
- GeneActiv, .bin raw data is passed through `?GENEAread::recalibrate()` first and metrics are computed.
- Note that this workflow does not eliminate any file based on the threshold of calibration error.

## 2. Inputs and expectations (file formats, columns, epochs)

### What you provide
Depending on device type, you provide:
- Raw device files (ActiGraph `.gt3x`, Axivity `resampled`.csv`, GENEActiv `.bin`)

### Key expectations
- A consistent alignment ofmetric at the selected epoch length (`epoch_sec`; commonly 5 seconds or 60 seconds).
- Correct sample rate and dynamic range for raw devices as configured (or when required by some summary metrics).
- Consistent timezone handling (typically this is handled by device software but it is configurable here).

## 3. Quick Start: generate metrics with `?accel_summaries()` (epoch-level outputs)

```{r part1_prepare, include=FALSE}
library(universalaccel)

# Locate sample data bundled with the package (ActiGraph example)
actigraph_path <- system.file("extdata/actigraph", package = "universalaccel")
output_dir <- tempdir()
```

```{r part1_quickstart, echo=TRUE,message=FALSE, warning=FALSE}
# Run Part 1 metric generation. 
# See more:?universalaccel::accel_summaries()
accel_summaries(
  device        = "actigraph", #define device type
  data_folder   = actigraph_path, # data folder for batch processing
  output_folder = output_dir, # output folder
  epochs        = 60,
  sample_rate   = 100,
  dynamic_range = c(-8, 8),
  metrics       = c("MIMS","ENMO","MAD","COUNTS","AI","ROCAM"),
  apply_nonwear = TRUE
) 

```

## 4. Output files and variable list (epoch-level metrics)

After running part 1, you will typically see one or more CSV files written to `output_folder`.

```{r part1_list_outputs, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
# List generated CSVs
files <- list.files(output_dir, pattern = "UA_actigraph", full.names = TRUE)
# Processed files
basename(files)

filecheck <- function(pattern, index = 1) {
  f <- list.files(output_dir, pattern = pattern, full.names = TRUE)
  if (!length(f)) stop("No files found.")
  if (index > length(f)) stop("Index out of range.")

  readr::read_csv(f[index], n_max = 3, show_col_types = FALSE)
}

filecheck("UA_actigraph", 1) |>
  dplyr::select(
    time,
    ID,
    AI,
    Vector.Magnitude,
    ENMO,
    MAD,
    MIMS_UNIT
  ) |>
  knitr::kable()

```

### Typical epoch-level variables (what they mean)
Exact columns depend on device and selected metrics, but commonly include:

- `time` (*timestamp*; start of the epoch)
- `ID` or `id` (*participant ID*; derived from file name or metadata)
- `epoch_sec` (*epoch length in seconds*)
- `ENMO` (*Euclidean Norm Minus One*)
- `MAD` (*Mean Amplitude Deviation*)
- `AI` (*Activity Index*)
- `MIMS_UNIT` (*Monitor-Independent Movement Summary unit*)
- `ROCAM` (*Rate of Change Acceleration Movement*)
- `Axis1`, `Axis2`, `Axis3` or `X`, `Y`, `Z` (*axis components*)
- `Vector.Magnitude` (*ActiGraph/Activity Counts*)
- `choi_nonwear` (*nonwear flag: epoch-aware*)


```{r renv_pin_example, eval=FALSE}
# In your UA project root:
renv::init()      # once
renv::snapshot()  # whenever dependencies change
```


\newpage

# Part 2 — Analysis & Interpretation (precomputed files → distributions → zones → percentiles)

## 6. What “analysis-ready” means in UA

### What you provide
Running this part necessitates pre-computed data of summary metric(s). Therefore, you provide:

- A pre-computed/processed table already aligned to an epoch and containing metric columns with age and sex columns.
- Note that the Second part is run on a file whose nonwear time was already removed (choi method was used 
when generating NHANES comparisons). Ideally one would pass UA part 1 outputs to part 2. 

An “analysis-ready” UA file has:

- consistent time and epoch (`epoch_sec`)
- consistent metric naming (e.g., `enmo`, `mad`, `mims_unit`, `ac`)
- enough metadata to interpret results (age/sex when relevant; location label)

In UA, Part 2 analysis commonly produces:

- **daily distributions** (bins; minutes across intensity ranges)
- **zone summaries** (movement zones from NHANES references)
- **AA** (Average acceleration) and **IG** (Intensity gradient)
- **NHANES positioning** (percentiles and anchor-conditioned lookups)

## 7. Daily summaries and binned distributions (bins, zones)

Two common analysis constructs:

- **AA (Average acceleration/Volume):** the time-weighted mean intensity over the day.
- **IG (Intensity gradient):** the slope from regressing log(time-in-bin) on log(intensity-bin-midpoint).

Conceptually:

- Bins summarize *how much time* is accumulated in each intensity range.
- Zones group bins into interpretable “movement zones” based on normative boundaries.

## 8. NHANES references (National Health and Nutrition Examination Survey)

NHANES references provide:

- **normative zone boundaries** (per metric, epoch, NHANES age group, and sex when available)
- **normative percentiles** for AA (Average acceleration) and IG (Intensity gradient), by NHANES age ranges (e.g., Age 3–19 and Age 20–80)

UA uses NHANES references to answer:

- “Where does this person-day rank relative to a U.S. reference?”
- “What would other metrics look like at the same **anchor** percentile?” (anchor-conditioned lookup)

## 9. Quick Start (Part 2): run analysis on the bundled precomputed demo file

UA includes a small but “analysis-capable” precomputed demo file under:

`inst/extdata/Precomputed/UA_FLASH_sample.csv`

This demo is intentionally larger than the tiny raw samples (so AA, IG, and weekly rollups are meaningful).

```{r part2_quickstart, include=FALSE}
library(universalaccel)
library(readr)
library(dplyr)
# Precomputed demo file shipped with the package
pre_base <- "UA_FLASH_sample"
pre_csv  <- system.file(
  "extdata/Precomputed",
  paste0(pre_base, ".csv"),
  package = "universalaccel"
)
stopifnot(nzchar(pre_csv))

# Where to write Part 2 outputs
out_root <- tempdir()                 
```

# Run Part 2 analysis 
```{r part2_run, echo=TRUE}
library(universalaccel)

analysis <- ua_analyze_precomputed(
  in_path     = pre_csv, # Specify where your dataset is at
  out_dir     = out_root,# Specify output directory
  location    = "ndw",
  make_weekly = TRUE,
  overwrite   = TRUE
)
```

```{r part2_preview_internal, echo=FALSE, message=FALSE, warning=FALSE}
run_root <- file.path(out_root, "UA_runs")
runs <- list.dirs(run_root, recursive = FALSE, full.names = TRUE)
if (length(runs)) {
  runs_sorted <- runs[order(basename(runs))]
  part2_dir <- tail(runs_sorted, 1)

  preview <- function(pattern) {
    f <- list.files(part2_dir, pattern = pattern, full.names = TRUE)
    if (!length(f)) return(NULL)
    readr::read_csv(f[1], n_max = 10, show_col_types = FALSE,
                    col_types = readr::cols(sex = readr::col_character(),
                                            sex_name = readr::col_character(),
                                            .default = readr::col_guess()))
  }

preview_n <- function(n) {
  pattern <- sprintf("UA_Output%d_", n)
  preview(pattern)
}
}
```


## 10. Output tables (Output1–Output5) and variable lists

This manual assumes the Part 2 runner produces:

### Output1 — Daily intensity distributions 
**Purpose:** minute distribution across bins, with zone assignment.  
**Common variables:**

- `id`, `day`, `epoch_sec`, `location`, `metric`
- `lower`, `upper`, `midpoint` (*bin boundaries*)
- `time_bin_min` (*minutes in bin*)
- `intensity distribution zones` (*zone labels*)

```{r part2_preview1, echo=FALSE, message=FALSE, warning=FALSE}
cols_bins <- c(
  "id",  "sex",  "age",  "metric",  "epoch_sec",  "bin_i",  "day",  "midpoint",  "time_bin_min", "cm_time_min"
)

knitr::kable(
  preview_n(1) |>
    dplyr::select(any_of(cols_bins))
)

```
### Output2 — Distribution summary and metric conversions
**Purpose:** summarize minutes and intensity within zones; attach NHANES references.  
**Common variables:**

- `minutes_in_zone` (*observed minutes*)
- `observed_intensity` (*observed time-weighted mean within zone*)
- `nhanes_anchor_*` (*NHANES reference metric whose scale was used to map/equate other summary metrics*)
- `equated_*` (*NHANES mean/SE for other metrics mapped onto the same anchor-zone definition*)

```{r part2_preview2, echo=FALSE, message=FALSE, warning=FALSE}
cols_bins2 <- c(
  "id","	day",	"anchor",	"intensity_zone",	"observed_mean_intensity", "nhanes_anchor_mean_nhanesw"
)

knitr::kable(
  preview_n(2) |>
    dplyr::select(any_of(cols_bins2))
)

```
### Output3 — Percentile positioning (Volume + IG), NHANES reference lookup
**Purpose:** (1) find your anchor percentile; (2) report NHANES values for other metrics at that same anchor percentile.  
**Common variables:**

- `anchor_value_obs` (*observed Volume or IG for the anchor metric*)
- `anchor_nearest_centile` (*nearest NHANES centile for that value*)
- `nhanes_<m>_value_at_anchor_centile` (*NHANES value for metric m at that same centile under the same anchor panel*)
- `nhanes_<m>_centile_used` (*centile actually used; should match anchor centile unless snapped*)

```{r part2_preview3, echo=FALSE, message=FALSE, warning=FALSE}
cols_bins3 <- c(
  "id",	"day",	"sex",	"age	","age_range",	"anchor",	"stat",	"anchor_value_observed"
)

knitr::kable(
  preview_n(3) |>
    dplyr::select(any_of(cols_bins3))
)
```
### Output4 — Weekly summaries

**Purpose:** quick weekly averaging across days.  
**Common variables:**
- `week`, `n_days`, `overall_intensity_mean`, `ig_slope_mean`

```{r part2_preview4, echo=FALSE, message=FALSE, warning=FALSE}
cols_bins4 <- c(
  "id",	"metric",	"period_type",	"period_id"	,	"observed_total_minutes",	"observed_mean_intensity",	"observed_ig"
  )

knitr::kable(
  preview_n(4) |>
    dplyr::select(any_of(cols_bins4))
)
```

### Output5 — Run report (log)

**Purpose:** a plain-language summary of what ran, what was produced, and how to interpret the columns.

### Reference

**Part1 Implementation** https://doi.org/10.1123/jmpb.2025-0024
